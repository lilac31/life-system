# 多端同步调试指南

## 🔍 已添加调试工具

我在页面右下角添加了一个**同步调试器**，可以帮助你诊断同步问题。

### 如何使用调试器

1. 打开 http://localhost:3000
2. 在右下角会看到蓝色边框的"同步调试器"面板
3. 如果没看到，按 `Ctrl/Cmd + Shift + D` 切换显示

### 调试器功能

#### 📊 状态信息
- GitHub Token 是否配置
- 用户ID（基于Token生成）
- GitHub 用户名
- Gist ID（云端存储ID）
- 本地数据大小
- 同步状态
- 最后同步时间

#### 🧪 测试按钮

1. **测试上传同步**
   - 创建测试数据并上传到 GitHub Gist
   - 验证上传和下载是否正常
   - 显示详细的测试结果

2. **测试下载**
   - 从云端下载数据
   - 查看云端存储的内容

3. **清除所有数据**
   - 清空所有 localStorage 数据
   - 重置到初始状态

## 📝 诊断步骤

### 第1步：检查配置

打开调试器，查看：
- ✅ GitHub Token: 应该显示"已配置"
- ✅ 用户ID: 应该有值（类似 `github_token_xxxxx`）

如果没有配置：
1. 点击右上角的同步状态
2. 点击"设置"
3. 输入 GitHub Token

### 第2步：测试上传

1. 点击"🧪 测试上传同步"按钮
2. 观察控制台输出（按 F12 打开）
3. 应该看到类似的日志：
```
=== 开始测试同步 ===
✓ Token 已配置
✓ 用户ID: github_token_xxxxx
开始上传测试数据...
✓ 上传成功: gist_id_xxxxx
开始下载数据验证...
✓ 下载成功，任务数量: 1
```

### 第3步：验证多端同步

#### 方法1：使用无痕窗口

1. **在当前窗口**：
   - 确保已配置 Token 并测试成功
   - 记住你的 GitHub Token

2. **打开无痕窗口**：
   - 按 `Ctrl/Cmd + Shift + N`
   - 访问 http://localhost:3000
   - 在设置界面输入**相同的 GitHub Token**

3. **观察调试器**：
   - 用户ID 应该相同
   - Gist ID 应该相同
   - 点击"测试下载"，应该能看到之前的数据

4. **测试实时同步**：
   - 在窗口1添加任务
   - 等待10-15秒
   - 窗口2应该自动显示新任务

## 🐛 常见问题排查

### 问题1：Token 未配置

**症状**：调试器显示"✗ 未配置"

**解决**：
1. 访问 https://github.com/settings/tokens
2. 点击 "Generate new token (classic)"
3. 勾选 `gist` 权限
4. 生成并复制 Token
5. 在应用中配置

### 问题2：上传失败

**症状**：点击"测试上传同步"显示错误

**可能原因**：
- Token 权限不足（需要 `gist` 权限）
- Token 已过期
- 网络问题

**解决**：
1. 打开控制台查看详细错误
2. 检查 Token 是否有 gist 权限
3. 尝试重新生成 Token

### 问题3：数据未同步

**症状**：在另一个浏览器看不到数据

**检查清单**：
- [ ] 两个浏览器使用的是**完全相同**的 GitHub Token
- [ ] 调试器显示的用户ID是否相同
- [ ] 调试器显示的 Gist ID 是否相同
- [ ] 是否等待了10-15秒（轮询间隔）

**强制同步**：
1. 点击右上角同步状态
2. 点击"立即同步"按钮

### 问题4：轮询未启动

**症状**：控制台没有看到"启动云端数据轮询"日志

**检查**：
1. 打开控制台（F12）
2. 刷新页面
3. 应该看到：`启动云端数据轮询，间隔: 10000 ms`

**如果没有**：
- 检查是否配置了 GitHub Token
- 检查网络是否正常

## 🔬 详细日志说明

### 正常的同步流程日志：

```
启动云端数据轮询，间隔: 10000 ms
获取GitHub用户信息 - 用户名: your_name, Token ID: github_token_xxxxx
查找用户的Gist，用户ID: github_token_xxxxx
找到本地存储的Gist ID: xxxxx
本地Gist有效且属于当前用户
检查云端更新 - 云端时间: 2025-11-16T... 本地时间: null
检测到云端数据更新，开始同步...
下载到的Gist数据: {...}
数据匹配，用户ID: github_token_xxxxx
云端数据与本地不同，开始合并...
合并完成: {...}
云端数据已同步到本地
```

### 数据上传日志：

```
开始上传数据到GitHub Gist
查找用户的Gist，用户ID: github_token_xxxxx
更新现有Gist: xxxxx
上传响应: {...}
保存Gist ID: xxxxx 更新时间: 2025-11-16T...
```

## 💡 测试建议

### 完整测试流程：

1. **清除环境**（可选）
   - 点击"清除所有数据"
   - 刷新页面

2. **配置 Token**
   - 输入 GitHub Token
   - 保存设置

3. **测试上传**
   - 点击"测试上传同步"
   - 确认成功

4. **打开第二个浏览器**
   - 使用无痕模式或不同浏览器
   - 输入相同的 Token
   - 点击"测试下载"
   - 应该能看到测试数据

5. **实时同步测试**
   - 窗口1：添加新任务
   - 等待15秒
   - 窗口2：应该自动刷新并显示新任务

## 🎯 期望结果

如果一切正常，你应该看到：

- ✅ 调试器显示所有配置正常
- ✅ 测试上传成功
- ✅ 在不同浏览器用相同 Token 能看到相同数据
- ✅ 修改数据后，其他浏览器会在10-15秒内自动更新
- ✅ 控制台显示正常的轮询和同步日志

## 📞 获取帮助

如果遇到问题，请：

1. 截图调试器面板
2. 复制控制台的完整日志
3. 描述具体的操作步骤和期望结果
4. 说明实际发生了什么

这样我可以更快地帮你定位问题！
