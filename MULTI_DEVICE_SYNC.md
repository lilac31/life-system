# 多端同步功能说明

## 功能概述

本项目已实现真正的多端实时同步功能。只要在不同浏览器或设备上使用**相同的 GitHub Token**，数据就会自动同步。

## 实现原理

1. **用户标识**：使用 GitHub Token 的哈希值作为唯一用户标识
2. **数据存储**：使用 GitHub Gist 作为免费云存储
3. **实时同步**：每10秒自动检查云端数据更新
4. **智能合并**：自动合并本地和云端数据，避免数据冲突

## 测试步骤

### 1. 首次设置

在第一个浏览器窗口中：

1. 打开 http://localhost:3000
2. 首次访问会看到云同步设置界面
3. 输入你的 GitHub Personal Access Token
   - 如何获取 Token：访问 https://github.com/settings/tokens
   - 点击 "Generate new token (classic)"
   - 勾选 `gist` 权限
   - 生成并复制 Token
4. 点击"保存并开始使用"

### 2. 添加数据

在第一个浏览器窗口中：

1. 添加一些任务或日程
2. 观察右上角的同步状态，确保显示"已同步"
3. 可以打开浏览器控制台查看同步日志

### 3. 多端同步测试

**方法1：使用无痕模式**

1. 打开浏览器的无痕窗口（隐私模式）
2. 访问 http://localhost:3000
3. 在云同步设置界面输入**相同的 GitHub Token**
4. 点击"保存并开始使用"
5. 等待几秒钟，你会看到之前添加的数据自动出现！

**方法2：使用不同浏览器**

1. 打开另一个浏览器（如 Chrome、Firefox、Safari）
2. 访问 http://localhost:3000
3. 输入**相同的 GitHub Token**
4. 数据会自动同步过来

### 4. 实时同步测试

在两个浏览器窗口中：

1. 在第一个窗口添加新任务
2. 等待约10秒（轮询间隔）
3. 第二个窗口会自动刷新，显示新添加的任务
4. 反之亦然，在第二个窗口添加的数据也会同步到第一个窗口

## 技术特性

### 1. 自动轮询检查

- 每10秒检查一次云端数据更新
- 只有当云端数据确实发生变化时才会同步
- 避免不必要的网络请求

### 2. 智能数据合并

- 使用任务ID去重，避免重复数据
- 自动合并不同设备的数据
- 保留所有设备的修改

### 3. 用户隔离

- 每个 GitHub Token 生成唯一的用户ID
- 不同 Token 的数据完全隔离
- 相同 Token 在不同设备上共享数据

### 4. 网络状态监控

- 自动检测网络连接状态
- 离线时暂停同步
- 上线时自动恢复同步

## 控制台日志

打开浏览器开发者工具（F12），在控制台可以看到详细的同步日志：

```
启动云端数据轮询，间隔: 10000 ms
检查云端更新 - 云端时间: 2025-11-16T10:30:00Z 本地时间: 2025-11-16T10:29:50Z
检测到云端数据更新，开始同步...
云端数据与本地不同，开始合并...
合并完成: {...}
云端数据已同步到本地
```

## 同步状态指示器

右上角的同步状态指示器显示：

- 🟢 **已同步**：数据已成功同步到云端
- 🔵 **同步中...**：正在上传或下载数据
- 🔴 **同步失败**：网络错误或权限问题
- ⚪ **离线**：当前无网络连接

点击同步状态可以：
- 查看当前 GitHub 用户名
- 查看最后同步时间
- 手动触发同步
- 修改同步设置
- 清除所有配置

## 常见问题

### Q: 数据没有同步怎么办？

1. 检查网络连接是否正常
2. 确认 GitHub Token 是否有效
3. 查看同步状态是否显示错误
4. 可以点击"立即同步"手动触发同步

### Q: 如何重置同步配置？

1. 点击右上角的同步状态
2. 点击"清除"按钮
3. 刷新页面重新配置

### Q: 为什么要等10秒才能看到更新？

这是轮询间隔时间，可以在代码中调整：
```javascript
// 在 apiService.js 的 useDataSync hook 中
dataSyncService.startPolling(10000); // 修改这个值（单位：毫秒）
```

### Q: 数据安全吗？

- 数据存储在 GitHub Gist 中，设置为私有（private）
- 只有拥有 Token 的人才能访问
- 建议定期轮换 Token 以提高安全性

## 代码说明

主要修改的文件：

1. **src/services/apiService.js**
   - 添加了轮询机制（`startPolling`、`stopPolling`）
   - 实现了云端数据检查（`checkCloudUpdates`）
   - 改进了数据合并逻辑（`mergeData`）
   - 添加了数据变更监听器（`addDataChangeListener`）

2. **src/hooks/useDataSync.js**
   - 添加了云端数据更新事件监听
   - 实现了自动重新加载数据

3. **src/App.jsx**
   - 添加了全局数据更新监听
   - 使用 key 属性触发组件重新渲染

## 部署到生产环境

1. 构建项目：`npm run build`
2. 部署到任何静态托管服务（GitHub Pages、Vercel、Netlify等）
3. 用户在任何设备上访问，使用相同的 GitHub Token 即可实现数据同步

## 未来改进

- [ ] 支持冲突解决策略选择
- [ ] 添加数据版本历史
- [ ] 实现增量同步（只同步变更的部分）
- [ ] 添加数据加密选项
- [ ] 支持离线编辑队列
